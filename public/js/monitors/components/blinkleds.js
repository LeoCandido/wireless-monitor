define(["jquery","moment","monitors/timeout","monitors/monitor"],function(t,e,n,i){function o(){console.info("promise loaded.")}function r(t){setTimeout(function(){i.measures(m,d,u).done(function(e){var n=e.items;t.load(n),t.setTimeline(n),t.render(),r(t)})},n)}var m=t("input#id").val(),s=t("div#monitor-view"),d=10,u="desc",l={moment:function(){return function(t,n){return e(n(t)).fromNow()}}},a=function(e,n){this.template=e,this.monitor=t.extend(n,l),this.timeline=[],this.monitor.currentTimelineItem=null,this.monitor.LIMIT=d};a.prototype.getLeds=function(){return t.extend(!0,{},this.monitor.data).leds},a.prototype.setCurrentLeds=function(t){this.monitor.currentLeds=t},a.prototype.load=function(t){if(t=t||[],t.length>0){this.monitor.created_at=t[0].created_at;var e=t[0],n=this.renderItem(e);this.setCurrentLeds(n)}},a.prototype.render=function(){var t=i.render(this.template,this.monitor);s.html(t)},a.prototype.renderItem=function(t){for(var e=this.getLeds(),n=t.data.leds,i=0;i<n.length;i++)for(var o=0;o<e.length;o++)n[i].id===e[o].id&&(e[o].on="on"===n[i].status);return e},a.prototype.setTimeline=function(t){this.monitor.timeline=t},a.prototype.renderTimelineItem=function(t){var e=void 0;if(t){for(var n=this.monitor.timeline.length,i=0;i<n&&(e=this.monitor.timeline[i],e.id!=t);i++);e.leds=this.renderItem(e)}this.monitor.currentTimelineItem=e},t.when(t.get("/templates/blinkleds/show.mustache"),i.fetch(m,o),i.measures(m,d,u,o)).done(function(e,n,i){var o=e[0],m=n[0].monitor,d=i[0].items,u=new a(o,m);u.load(d),u.setTimeline(d),u.render(),d.length||(s.html(""),t(".nav-tabs a#tab-setup").tab("show")),r(u),t(document).on("click",".bottom-element a",function(){var e=t(this).data("id");return u.renderTimelineItem(e),u.render(),!1}).on("click","button.btn-close",function(){return u.renderTimelineItem(),u.render(),!1})})});